<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Labirinto</title>

<style>
    body {
        font-family: Arial, sans-serif;
        text-align: center;
        background: #111;
        color: white;
    }

    canvas {
        background: #222;
        margin-top: 20px;
        border: 2px solid white;
        max-width: 95vw;
    }

    textarea {
        width: 300px;
        height: 60px;
        margin-top: 15px;
        font-size: 16px;
    }

    button {
        margin: 5px;
        padding: 8px 20px;
        font-size: 16px;
        cursor: pointer;
    }

    #message {
        margin-top: 15px;
        font-size: 18px;
        font-weight: bold;
        height: 24px;
    }
	
	#rankingContainer {
	  display: flex;
	  justify-content: center;
	  margin-top: 20px;
	}

	#rankingContainer table {
	  border-collapse: collapse;
	  min-width: 400px;
	}
	
</style>
</head>
<body>

<h2>Aplicando algoritmos - Labirinto</h2>

<canvas id="game"></canvas>

<br>
<textarea id="commands" placeholder="Digite comandos: A E D"></textarea>
<br>
<button id="runBtn">Executar</button>
<button onclick="resetGame()">Resetar</button>

<div id="message"></div>

<h2 style="text-align:center;">Ranking do Dia</h2>

<div id="rankingContainer">
  <table border="1">
    <thead>
      <tr>
        <th>¬∫</th>
        <th>Nome</th>
        <th>Passos</th>
        <th>Conjuntos</th>
		<th>Escola</th>
      </tr>
    </thead>
    <tbody id="rankingBody"></tbody>
  </table>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let totalSteps = 0;
let totalSubmissions = 0;
let escola;

const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwldQViwZ609YbAZOZgTXURUmLiWFCmw9i0bDxSqr1l9tSpZvfaRG1F2u-wlU37_HAR8g/exec";
const params = new URLSearchParams(window.location.search);
const paramEscola = params.get("ec");

if (paramEscola === "m") {
	escola = "Maria Leite";
} else if (paramEscola === "g") {
	escola = "Gon√ßala";
} else if (paramEscola === "p") {
	escola = "JBBA";
}

async function enviarNome(nome) {
  try {
  
	let data = {
	  nome: nome,
	  passos: totalSteps,
	  conjuntos: totalSubmissions,
	  escola: escola
	};
	
    const response = await fetch(WEB_APP_URL, {
      method: "POST",
      body: JSON.stringify(data)
    });

    const result = await response.json();

    if (result.status === "ok") {
      document.getElementById("message").textContent =
        "‚úÖ Nome enviado com sucesso!";
    } else {
      document.getElementById("message").textContent =
        "‚ùå Erro inesperado.";
    }

  } catch (err) {
    document.getElementById("message").textContent =
      "‚ùå Falha na conex√£o.";
    console.error(err);
  }
}

const tileSize = 40;


const maze = [
[0,1,0,0,0,1,0,0,0,1,0,0],
[0,1,0,1,0,1,0,1,0,1,0,1],
[0,0,0,1,0,0,0,1,0,0,0,1],
[1,1,0,1,1,1,0,1,1,1,0,1],
[0,0,0,0,0,1,0,0,0,1,0,0],
[0,1,1,1,0,1,1,1,0,1,1,0],
[0,1,0,0,0,0,0,1,0,0,0,0],
[0,1,0,1,1,1,0,1,1,1,1,0],
[0,0,0,1,0,0,0,0,0,0,1,0],
[1,1,0,1,0,1,1,1,1,0,1,0],
[0,0,0,0,0,0,0,0,1,0,0,0],
[0,1,1,1,1,1,1,0,1,1,1,0]
];

const rows = maze.length;
const cols = maze[0].length;

canvas.width = cols * tileSize;
canvas.height = rows * tileSize;

const goal = { x: 7, y: rows - 1 };

let ship;
let execution;


function initShip() {
    ship = {
        x: 0,
        y: 0,
        direction: 1 // 0=N,1=E,2=S,3=W
    };
}

function drawMaze() {
    for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
            if (maze[y][x] === 1) {
                ctx.fillStyle = "#555";
                ctx.fillRect(x*tileSize, y*tileSize, tileSize, tileSize);
            } else {
                ctx.strokeStyle = "#333";
                ctx.strokeRect(x*tileSize, y*tileSize, tileSize, tileSize);
            }
        }
    }
}

function drawGoal() {
    ctx.fillStyle = "lime";
    ctx.fillRect(goal.x*tileSize, goal.y*tileSize, tileSize, tileSize);
}

function drawShip() {
    const centerX = ship.x*tileSize + tileSize/2;
    const centerY = ship.y*tileSize + tileSize/2;

    ctx.save();
    ctx.translate(centerX, centerY);
    ctx.rotate(ship.direction * Math.PI/2);

    ctx.fillStyle = "cyan";
    ctx.beginPath();
    ctx.moveTo(0, -tileSize/3);
    ctx.lineTo(tileSize/4, tileSize/3);
    ctx.lineTo(-tileSize/4, tileSize/3);
    ctx.closePath();
    ctx.fill();

    ctx.restore();
}

function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawMaze();
    drawGoal();
    drawShip();
}

function checkVictory() {
  if (ship.x === goal.x && ship.y === goal.y) {

    clearInterval(execution);

    const nome = prompt("üöÄ Vit√≥ria! Digite seu nome:");

    if (nome && nome.trim() !== "") {
      enviarNome(nome.trim());
    }
	
	carregarRanking();
  }
}

function moveForward() {
    let nx = ship.x;
    let ny = ship.y;

    if (ship.direction === 0) ny--;
    if (ship.direction === 1) nx++;
    if (ship.direction === 2) ny++;
    if (ship.direction === 3) nx--;

    if (
        nx >= 0 && nx < cols &&
        ny >= 0 && ny < rows &&
        maze[ny][nx] === 0
    ) {
        ship.x = nx;
        ship.y = ny;
        checkVictory();
    } else {
        document.getElementById("message").textContent = "üí• Bateu na parede!";
        clearInterval(execution);
    }
}

function turnLeft() {
    ship.direction = (ship.direction + 3) % 4;
}

function turnRight() {
    ship.direction = (ship.direction + 1) % 4;
}

function runCommands() {
    document.getElementById("message").textContent = "";

    let rawInput = document.getElementById("commands").value;
    let input = rawInput.toUpperCase();
    let commands = input.replace(/[^AED]/g, '').split('');
	
	if(commands.length > 0){
	   totalSubmissions++;
	   totalSteps += input.length;
	}

    if (commands.length === 0) {
        document.getElementById("message").textContent = "‚ö†Ô∏è Use apenas A, E ou D.";
        return;
    }

    let i = 0;
    clearInterval(execution);

    execution = setInterval(() => {

        if (i >= commands.length) {
            clearInterval(execution);
            return;
        }

        let cmd = commands[i];

        if (cmd === 'A') moveForward();
        else if (cmd === 'E') turnLeft();
        else if (cmd === 'D') turnRight();

        draw();
        i++;

    }, 500);
}

function resetGame() {
    clearInterval(execution);
    initShip();
	totalSubmissions = 0;
	totalSteps = 0;
    document.getElementById("message").textContent = "";
    draw();
}

function carregarRanking() {

  fetch("https://script.google.com/macros/s/AKfycbwldQViwZ609YbAZOZgTXURUmLiWFCmw9i0bDxSqr1l9tSpZvfaRG1F2u-wlU37_HAR8g/exec")
    .then(res => res.json())
    .then(data => {

      let tabela = document.getElementById("rankingBody");
      tabela.innerHTML = "";

      data.forEach((item, index) => {
        tabela.innerHTML += `
          <tr>
            <td>${index + 1}</td>
            <td>${item.nome}</td>
            <td>${item.passos}</td>
            <td>${item.conjuntos}</td>
			<td>${item.escola}</td>
          </tr>
        `;
      });

    })
    .catch(err => console.error("Erro ao carregar ranking:", err));
}


document.getElementById("commands").addEventListener("input", function() {
    this.value = this.value.toUpperCase();
});

document.getElementById("runBtn").addEventListener("click", runCommands);

window.onload = carregarRanking;

document.addEventListener("DOMContentLoaded", function() {
  carregarRanking();
});

initShip();
draw();
</script>

</body>
</html>
